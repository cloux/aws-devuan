#!/bin/sh
# 
# AWS EC2 cloud-init, see /etc/init.d/cloud-init
# This is started parallel in the background (nohup) by 20-parallel.sh
# (cloux@rote.ch)

export PATH=/usr/sbin:/usr/bin:/sbin:/bin

# make sure the network is up
printf "Network: eth0 is %s\n" "$(cat /sys/class/net/eth0/operstate)"
if [ "$(cat /sys/class/net/eth0/operstate)" != up ]; then
	ifup --all --ignore-errors
	printf "Network: eth0 is now %s\n\n" "$(cat /sys/class/net/eth0/operstate)"
fi

# AWS EC2 cloud-init, see /var/log/cloud-init.log
[ -x "/usr/bin/cloud-init" ] || exit

# clean up
rm -f /var/log/cloud-init.log /var/log/cloud-init-output.log

# load config
[ -r /etc/default/cloud-init ] && . /etc/default/cloud-init

# init
/usr/bin/cloud-init init
/usr/bin/cloud-init init --local
/usr/bin/cloud-init modules --mode config
/usr/bin/cloud-init modules --mode final
